@model TheRewind.Models.Movie

@if (TempData["Error"] is string err)
{
  <div class="alert alert-danger">@err</div>
}

<div class="row g-4">
  <div class="col-md-8">
    @* Owner-only edit/delete buttons appear when the current user owns this movie *@
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">@Model.Title</h2>
      @if (Context.Session.GetInt32("userId") == Model.UserId)
      {
        <div class="btn-group">
          <a class="btn btn-sm btn-warning" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
          <a class="btn btn-sm btn-danger" asp-action="Delete" asp-route-id="@Model.Id">Delete</a>
        </div>
      }
    </div>
    <dl class="row">
      <dt class="col-sm-3">Genre</dt>
      <dd class="col-sm-9">@Model.Genre</dd>
      <dt class="col-sm-3">Release Date</dt>
      <dd class="col-sm-9">@Model.ReleaseDate.ToString("yyyy-MM-dd")</dd>
      <dt class="col-sm-3">Description</dt>
      <dd class="col-sm-9">@Model.Description</dd>
      <dt class="col-sm-3">Added by</dt>
      <dd class="col-sm-9">@Model.User?.Username</dd>
      <dt class="col-sm-3">Added on</dt>
      <dd class="col-sm-9">@Model.CreatedAt.ToString("MMM d, yyyy")</dd>
      <dt class="col-sm-3">Last updated</dt>
      <dd class="col-sm-9">@Model.UpdatedAt.ToString("MMM d, yyyy h:mm tt")</dd>
    </dl>

    @if (Model.Ratings != null && Model.Ratings.Count > 0)
    {
      <p class="card-text mb-2">Rated by:</p>
      <div class="d-flex flex-wrap gap-2 mb-3">
        @foreach (var r in Model.Ratings)
        {
          <span class="badge rounded-pill text-bg-primary">@r.User?.Username</span>
        }
      </div>
    }

    <div class="mt-3">
      <a class="btn btn-secondary" asp-action="Index">Back</a>
      @if (Context.Session.GetInt32("userId") == Model.UserId)
      {
        <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
        <a class="btn btn-danger" asp-action="Delete" asp-route-id="@Model.Id">Delete</a>
      }
    </div>
  </div>

  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Stats</h5>
        @* Average rating is computed in the controller and provided via ViewBag.Average *@
        @{ double avg = 0; if (ViewBag.Average != null) { avg = (double)ViewBag.Average; } }
        <p class="mb-2">
          <strong>Average:</strong>
          @(avg == 0 ? "No ratings" : avg.ToString("0.0"))
        </p>
        <p class="mb-3"><strong>Total Ratings:</strong> @(Model.Ratings?.Count ?? 0)</p>

        @if (ViewBag.HasRated == false)
        {
          @* When logged in and haven't rated yet, show the rating form *@
          <p class="text-muted">Be the first to rate this movie if you haven’t already!</p>
          <form asp-action="Rate" asp-route-id="@Model.Id" method="post" class="d-flex align-items-end gap-2" data-disable-on-submit>
            <div class="flex-grow-1">
              <label class="form-label">Rate</label>
              <select name="value" class="form-select">
                <option>1</option>
                <option>2</option>
                <option>3</option>
                <option>4</option>
                <option>5</option>
              </select>
            </div>
            <button type="submit" class="btn btn-outline-primary">
              ⭐ Submit
            </button>
          </form>
        }
        else
        {
          <div class="text-success">You have already rated this movie.</div>
        }
      </div>
    </div>
  </div>
</div>